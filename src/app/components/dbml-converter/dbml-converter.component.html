<app-header></app-header>

<!-- =================== -->
<!--  EDITOR VIEW MODE  -->
<!-- =================== -->
@if (showEditor()) {
<app-editor-view>
  <!-- Header editor-view -->
  <div editor-explorer>
    <div
      class="flex items-center justify-between border-b border-border-muted bg-bg-secondary"
    >
      <h2 class="py-2 text-sm font-medium text-zinc-300 px-4">Explorer</h2>
      <!-- Convert / Clear actions -->
      <div class="flex gap-2 mr-2">
        <button
          (click)="handleConvert()"
          class="flex items-center gap-2 cursor-pointer px-2 bg-teal-600 text-white rounded disabled:cursor-not-allowed disabled:opacity-50"
          [disabled]="isConverting()"
        >
          Convert
        </button>
        <button
          (click)="clearAll()"
          class="cursor-pointer px-2 rounded text-text-muted hover:text-text"
        >
          Clear
        </button>
      </div>
    </div>

    <!-- Output type selector in editor mode -->
    <div class="mt-4 px-4">
      <label class="text-xs font-medium text-text-muted block mb-2"
        >Output format:</label
      >
      <app-expanding-circle-button
        [options]="expandingButtonOptions()"
        [selectedId]="selectedOutputType()"
        (optionSelected)="setOutputType($event)"
      ></app-expanding-circle-button>
    </div>

    <div class="flex-1 overflow-auto p-2 px-3">
      <!-- Input folder -->
      <div class="mb-2">
        <div
          class="flex items-center gap-1 px-2 py-1 hover:bg-bg-secondary rounded cursor-pointer"
          (click)="toggleFolder('input')"
        >
          @if (expandedFolders().has('input')) {
          <open-folder-icon
            className="w-4 h-4 mr-2"
            [class]="
              expandedFolders().has('input') ? 'text-text' : 'text-text-muted'
            "
          ></open-folder-icon>
          }
          <!--  -->
          @else {
          <folder-icon className="w-4 h-4 text-text-muted mr-2"></folder-icon>
          }
          <span
            class="text-sm"
            [class.text-text]="expandedFolders().has('input')"
            [class.text-zinc-300]="!expandedFolders().has('input')"
            >input</span
          >
        </div>

        @if (expandedFolders().has('input')) {
        <div class="ml-6">
          <div
            class="flex items-center gap-2 px-2 py-1 hover:bg-bg-secondary rounded cursor-pointer"
            [class.bg-bg-secondary]="selectedFile() === null"
            (click)="selectFileInEditor(null)"
          >
            <file-icon
              [class.text-text-muted]="selectedFile() !== null"
              [class.text-accent]="selectedFile() === null"
              className="w-4 h-4 mr-2"
            ></file-icon>

            <span
              [class.text-accent]="selectedFile() === null"
              [class.text-zinc-300]="selectedFile() !== null"
              class="text-sm"
              >input.txt</span
            >
          </div>
        </div>
        }
      </div>

      <!-- Output folder -->
      @if (files().length > 0) {
      <div class="mb-2">
        <div
          class="flex items-center gap-1 px-2 py-1 hover:bg-bg-secondary rounded cursor-pointer"
          (click)="toggleFolder('output')"
        >
          @if (expandedFolders().has('output')) {
          <open-folder-icon
            [class.text-text]="expandedFolders().has('output')"
            [class.text-text-muted]="!expandedFolders().has('output')"
            className="w-4 h-4 mr-2"
          ></open-folder-icon>
          }
          <!--  -->
          @else {
          <folder-icon className="w-4 h-4 text-text-muted mr-2"></folder-icon>
          }

          <span
            class="text-sm"
            [class.text-text]="expandedFolders().has('output')"
            [class.text-zinc-300]="!expandedFolders().has('output')"
            >output</span
          >
          <span class="ml-auto text-xs text-text-muted">{{
            files().length
          }}</span>
        </div>

        @if (expandedFolders().has('output')) {
        <div class="ml-6 space-y-1">
          @for (file of files(); track file.id) {
          <div
            class="flex items-center gap-2 px-2 py-1 hover:bg-bg-secondary rounded cursor-pointer"
            [class.bg-bg-secondary]="selectedFile()?.id === file.id"
            (click)="selectFileInEditor(file)"
          >
            <file-icon
              [class.text-text-muted]="selectedFile()?.id !== file.id"
              [class.text-accent]="selectedFile()?.id === file.id"
              className="w-4 h-4 mr-2"
            ></file-icon>
            <span
              class="text-sm"
              [class.text-zinc-300]="selectedFile()?.id !== file.id"
              [class.text-accent]="selectedFile()?.id === file.id"
              >{{ file.filename }}</span
            >
            <span class="ml-auto text-xs text-text-muted">{{
              file.content | codeChars
            }}</span>
          </div>
          }
        </div>
        }
      </div>
      }
    </div>
  </div>

  <!-- Editor area -->
  <div editor-area>
    <div class="flex flex-col h-full">
      <!-- Tab bar -->
      <div class="border-b border-border-muted bg-bg-secondary">
        <div class="flex">
          <div
            class="px-4 py-2 bg-zinc-900 border-r border-border-muted text-sm flex items-center gap-2"
          >
            <file-icon className="w-4 h-4 text-accent"></file-icon>
            <span class="font-mono text-accent text-sm">
              {{ selectedFile() ? selectedFile()?.filename : "input.txt" }}
            </span>
          </div>
        </div>
      </div>

      <!-- Editor content -->
      <div class="flex-1 overflow-auto p-6">
        @if (selectedFile() === null) {
        <!-- Input editor -->
        <div class="h-full">
          <app-dbml-code-editor
            [class.border-red-500]="hasError()"
            [code]="dbmlContent()"
            [height]="'400px'"
            (codeChange)="onDbmlInput($event)"
          ></app-dbml-code-editor>

          @if (hasError()) {
          <div class="mt-2 text-sm text-red-600 dark:text-red-400">
            {{ errorMessage() }}
          </div>
          }

          <div class="mt-2">
            <button
              class="text-xs text-accent hover:underline"
              (click)="handleLoadExample()"
            >
              Load example DBML code
            </button>
          </div>
        </div>
        } @else {
        <!-- Output file viewer -->
        <div
          class="h-full bg-bg-secondary border border-border-muted rounded-lg"
        >
          <div
            class="flex items-center justify-between px-4 py-3 border-b border-border-muted"
          >
            <div class="flex items-center gap-2">
              <span class="font-mono text-sm text-zinc-300">{{
                selectedFile()?.filename
              }}</span>
              <span class="text-xs text-text-muted"
                >{{ selectedFile()?.content | codeChars }} chars</span
              >
            </div>
            <!-- Copy & Download buttons -->
            <div class="flex gap-2">
              <copy-file-button
                [textToCopy]="selectedFile()?.content || ''"
              ></copy-file-button>
              <download-file-button
                [textToDownload]="selectedFile()?.content || ''"
                [fileName]="selectedFile()?.filename || 'file.txt'"
              ></download-file-button>
            </div>
          </div>
          <div class="p-4 h-full overflow-hidden">
            <app-code-viewer
              [height]="'400px'"
              [code]="selectedFile()?.content || ''"
              [language]="language()"
            >
            </app-code-viewer>
          </div>
        </div>
        }
      </div>
    </div>
  </div>
</app-editor-view>
}

<!-- =================== -->
<!--  PREVIEW VIEW MODE  -->
<!-- =================== -->
@if (showPreview()) {
<div class="grid grid-cols-1 md:grid-cols-2">
  <!-- ========== -->
  <!-- LEFT SIDE - Input Section -->
  <!-- ========== -->
  <div class="border-r border-border-muted flex flex-col">
    <div
      class="flex-col px-6 py-4 pb-6 border-b border-border-muted flex justify-between"
    >
      <h2 class="text-sm font-medium text-text">Input</h2>
      <div class="flex justify-between flex-row gap-2">
        <button
          class="text-xs text-accent hover:underline"
          (click)="handleLoadExample()"
        >
          Load example DBML code
        </button>

        <div class="flex gap-2">
          <button
            (click)="handleConvert()"
            class="flex items-center gap-2 cursor-pointer px-2 bg-teal-600 text-white rounded disabled:cursor-not-allowed disabled:opacity-50"
            [disabled]="isConverting()"
          >
            Convert
          </button>
          <button
            (click)="clearAll()"
            class="cursor-pointer px-2 rounded text-text-muted hover:text-text"
          >
            Clear
          </button>
        </div>
      </div>
    </div>
    <!-- Editor DBML con Prism -->
    <div class="py-6 px-6">
      <app-dbml-code-editor
        [class.border-red-500]="hasError()"
        [code]="dbmlContent()"
        [height]="'400px'"
        (codeChange)="onDbmlInput($event)"
      ></app-dbml-code-editor>
    </div>

    @if (hasError()) {
    <div class="mt-2 text-sm text-red-600 dark:text-red-400">
      {{ errorMessage() }}
    </div>
    }
  </div>

  <!-- ========== -->
  <!-- RIGHT SIDE - Output Section -->
  <!-- ========== -->
  <div class="border-r border-border-muted flex flex-col">
    <div class="px-6 py-4 border-b border-border-muted">
      <h2 class="text-sm font-medium text-zinc-300">Output</h2>
      <!-- Output type selector -->
      <div class="flex items-center space-x-2">
        <label class="text-sm text-gray-900 dark:text-text-muted"
          >Output format:</label
        >
        <app-expanding-circle-button
          [options]="expandingButtonOptions()"
          [selectedId]="selectedOutputType()"
          (optionSelected)="setOutputType($event)"
        ></app-expanding-circle-button>
      </div>
    </div>

    <!-- JSON Output -->
    @if (selectedOutputType() === OUTPUT_OPTIONS.json) {
    <div class="py-6 px-6 relative">
      <!-- Copy & Download buttons -->
      <div class="absolute flex right-10 top-8 gap-2">
        <copy-file-button
          [textToCopy]="schema() ? this.formatJson(schema()) : ''"
        ></copy-file-button>
        <download-file-button
          [textToDownload]="schema() ? this.formatJson(schema()) : ''"
          [fileName]="'schema.json'"
        ></download-file-button>
      </div>

      <!-- JSON Output -->
      <app-code-viewer
        [code]="schema() ? this.formatJson(schema()) : ''"
        [height]="'400px'"
        language="typescript"
      ></app-code-viewer>
    </div>
    }

    <!-- NestJS TypeORM Output -->
    @if (selectedOutputType() === OUTPUT_OPTIONS.typeorm) {
    <div class="w-full overflow-y-auto rounded-sm">
      @if (nestjsCode()) {
      <!-- Content for entities -->
      <div class="p-6">
        @for (fileEntry of getEntities(nestjsCode()!.entities); track
        fileEntry.fileName) {
        <file-drop-down
          [fileName]="fileEntry.fileName"
          [charsCount]="fileEntry.code | codeChars"
          [codeContent]="fileEntry.code"
        ></file-drop-down>
        }

        <!-- Default Database Module -->
        <file-drop-down
          fileName="database.module.ts"
          [charsCount]="nestjsCode()!.module | codeChars"
          [codeContent]="nestjsCode()!.module"
        ></file-drop-down>
      </div>
      }
    </div>
    }
  </div>
</div>
}
